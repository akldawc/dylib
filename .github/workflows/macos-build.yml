name: Build macOS .dylib (Universal)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 仅安装实际需要的第三方依赖，移除xcode-select
      - name: Install common dependencies
        run: |
          brew update && brew install cmake make swiftlint || true

      # 确保Xcode命令行工具可用（系统自带，仅触发安装）
      - name: Select Xcode command line tools
        run: |
          xcode-select --install || true

      # C/C++/OC（CMake构建）
      - name: Build for C/C++/OC (CMake)
        if: hashFiles('CMakeLists.txt') != ''
        run: |
          mkdir -p build && cd build
          cmake ..
          make -j$(sysctl -n hw.logicalcpu)
        continue-on-error: true

      # C/C++/OC（Makefile构建）
      - name: Build for C/C++/OC (Makefile)
        if: hashFiles('Makefile') != ''
        run: |
          make -j$(sysctl -n hw.logicalcpu)
        continue-on-error: true

      # Swift项目
      - name: Build for Swift
        if: hashFiles('Package.swift') != ''
        run: |
          swift build -c release
        continue-on-error: true

      # 上传产物
      - name: Upload all .dylib artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macOS-Dylib-All
          path: |
            **/*.dylib
            !**/node_modules/**
            !**/.git/**
          if-no-files-found: warn